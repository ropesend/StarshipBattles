# Task List: Ability System Migration

- [x] **Phase 1: Foundation (Abilities Module)** <!-- id: 0 -->
    - [x] **Infrastructure** <!-- id: 1 -->
        - [x] Create `abilities.py` module to host `Ability` classes <!-- id: 2 -->
        - [x] Implement `Ability` base class with `update`, `on_activation`, `get_ui_rows` methods <!-- id: 3 -->
    - [x] **Resource Abilities** <!-- id: 4 -->
        - [x] Migrate `ResourceConsumption` from `resources.py` to `abilities.py` <!-- id: 5 -->
        - [x] Migrate `ResourceStorage` from `resources.py` to `abilities.py` <!-- id: 6 -->
        - [x] Migrate `ResourceGeneration` from `resources.py` to `abilities.py` <!-- id: 7 -->
    - [x] **Core Mechanic Abilities** <!-- id: 8 -->
        - [x] Implement `CombatPropulsion` (replaces `thrust_force`) <!-- id: 9 -->
        - [x] Implement `ManeuveringThruster` (replaces `turn_speed`) <!-- id: 10 -->
        - [x] Implement `ShieldProjection` (replaces `Shield.capacity`) <!-- id: 11 -->
        - [x] Implement `VehicleLaunchAbility` (replaces `Hangar` logic) <!-- id: 71 -->
        - [x] Implement `ShieldRegeneration` (replaces `ShieldRegenerator.rate`) <!-- id: 12 -->
        - [x] Implement `CommandAndControl`, `CrewCapacity`, `LifeSupportCapacity` (Implicitly supported via primitive factory or generic classes if needed, currently not strictly required as separate classes but data-driven) <!-- id: 13 -->
    - [x] **Weapon Abilities** <!-- id: 14 -->
        - [x] Implement `WeaponAbility` base class (cooldowns, reload, range) <!-- id: 15 -->
        - [x] Implement `ProjectileWeaponAbility` (spawns projectiles) <!-- id: 16 -->
        - [x] Implement `BeamWeaponAbility` (hitscan logic) <!-- id: 17 -->
        - [x] Implement `SeekerWeaponAbility` (spawns seekers) <!-- id: 18 -->
    - [x] **Registry & Factory** <!-- id: 19 -->
        - [x] Define `ABILITY_REGISTRY` in `abilities.py` <!-- id: 20 -->
        - [x] Implement `create_ability(name, component, data)` factory function <!-- id: 21 -->
    - [x] **Testing** <!-- id: 22 -->
        - [x] Create `unit_tests/test_abilities.py` to verify all new classes <!-- id: 23 -->

- [x] **Phase 2: Core Refactor (Components)** <!-- id: 24 -->
0    - [x] **Component Class** <!-- id: 25 -->
        - [x] Refactor `Component.__init__` in `components.py` to strictly load abilities using the Factory <!-- id: 26 -->
        - [x] Implement `get_ability(type)` helper method <!-- id: 27 -->
        - [x] Refactor `update()` to iterate `self.ability_instances` and call `ab.update()` <!-- id: 28 -->
    - [x] **Legacy Shim (Critical)** <!-- id: 29 -->
        - [x] Add logic to `__init__`: If `thrust_force` in data, create `CombatPropulsion` ability <!-- id: 30 -->
        - [x] Add logic to `__init__`: If `turn_speed` in data, create `ManeuveringThruster` ability <!-- id: 31 -->
        - [x] Add logic to `__init__`: If `damage` in data, create appropriate `WeaponAbility` <!-- id: 32 -->
    - [x] **Testing** <!-- id: 33 -->
        - [x] Create `unit_tests/test_component_composition.py` to verify generic component behaves like an engine/weapon <!-- id: 34 -->


- [x] **Phase 3: Stats & Physics Integration** <!-- id: 35 -->
    - [x] **Ship Stats** <!-- id: 36 -->
        - [x] Create `unit_tests/test_ship_stats.py` baseline <!-- id: 81 -->
        - [x] Refactor `ship_stats.py`: Replace `if isinstance(c, Engine)` with `c.get_abilities('CombatPropulsion')` <!-- id: 37 -->
        - [x] Refactor `ship_stats.py`: Replace `if isinstance(c, Thruster)` with `c.get_abilities('ManeuveringThruster')` <!-- id: 38 -->
        - [x] Refactor `ship_stats.py`: Aggregate `ShieldProjection` for max shields <!-- id: 39 -->
    - [x] **Ship Physics** <!-- id: 40 -->
        - [x] Implement `Ship.get_total_ability_value(name, operational_only=True)` helper <!-- id: 74 -->
        - [x] Refactor `ship_physics.py`: Replace `isinstance(Engine)` loop with `get_total_ability_value('CombatPropulsion')` <!-- id: 41 -->
        - [x] Refactor `ship_stats.py`: Replace `isinstance(Engine)` loop with `get_total_ability_value` (unified logic) <!-- id: 75 -->
    - [x] **Verification** <!-- id: 42 -->
        - [x] Run `unit_tests/test_ship_stats.py` to ensure no regression in calculated stats <!-- id: 43 -->


- [x] **Phase 4: Combat System Migration** <!-- id: 44 -->
    - [x] **Weapon Logic** <!-- id: 45 -->
        - [x] Refactor `Ship.max_weapon_range` in `ship.py` to use ability values <!-- id: 80 -->
        - [x] Refactor `ship_combat.py`: `fire_weapons` iterates components with `WeaponAbility` <!-- id: 46 -->
        - [x] Update `WeaponAbility` to manage its own `cooldown_timer` <!-- id: 47 -->
        - [x] Bind `fire()` logic: Returns attack data to battle engine (design stable) <!-- id: 48 -->
        - [x] Refactor `fire_weapons`: Add `VehicleLaunchAbility` support for launching fighters <!-- id: 72 -->
        - [x] Refactor `_find_pdc_target`: Use `Ability.tags` instead of legacy flags <!-- id: 73 -->
        - [x] Refactor `ai.py`: Replace `isinstance(Weapon)` with `has_ability('WeaponAbility')` <!-- id: 82 -->
        - [x] Refactor `ai.py`: Update PDC detection to use `Ability.tags` instead of `abilities.get('PointDefense')` <!-- id: 83 -->
        - [x] Refactor `ai.py`: Replace `isinstance(Engine, Thruster)` in `_check_formation_integrity` with ability checks <!-- id: 84 -->
    - [x] **Weapon Subclass Migration** (from review_projectiles.md) <!-- id: 85 -->
        - [x] Replace 5 `isinstance(SeekerWeapon/BeamWeapon/ProjectileWeapon)` checks in `ship_combat.py` <!-- id: 86 -->
        - [x] Migrate direct `comp.damage`/`comp.range` access to ability values (via legacy shims) <!-- id: 87 -->
    - [x] **Resource Legacy Path** (from review_resources.md) <!-- id: 88 -->
        - [x] Shield regen energy consumption works correctly (aggregated ship-level design) <!-- id: 89 -->
        - [x] Fix EnergyConsumption trigger from "conditional" to "constant" in `abilities.py:278` <!-- id: 90 -->
    - [x] **Verification** <!-- id: 49 -->
        - [x] Run `unit_tests/test_weapons.py` to verify firing mechanics <!-- id: 50 -->

- [x] **Phase 5: UI & Capabilities** <!-- id: 51 -->
    - [x] **Renderer** <!-- id: 52 -->
        - [x] Implement `get_ui_rows()` for `CombatPropulsion` (Returns 'Thrust') <!-- id: 53 -->
        - [x] Implement `get_ui_rows()` for `WeaponAbility` (Returns 'Damage', 'Range') <!-- id: 54 -->
        - [x] Update `Component.get_ui_rows()` to aggregate from abilities <!-- id: 55 -->
        - [x] Replace `isinstance(Engine/Weapon/Armor)` in `rendering.py:122-124` with ability checks <!-- id: 91 -->
    - [x] **Builder UI** (Refactoring detail_panel.py) <!-- id: 56 -->
        - [x] Refactor `ui/builder/detail_panel.py` `show_component` to use `get_ui_rows()` <!-- id: 57 -->
        - [x] Refactor `ui/builder/weapons_panel.py`: Remove 8 `isinstance` checks, use `has_ability()` <!-- id: 76 -->
        - [x] Refactor `ui/builder/schematic_view.py`: Remove 4 weapon `isinstance` checks <!-- id: 92 -->
        - [x] Refactor `ui/builder/detail_panel.py`: Remove `isinstance(SeekerWeapon)` check <!-- id: 99 -->
        - [x] Update `ui/builder/modifier_logic.py`: Replace `type_str` checks with ability checks <!-- id: 93 -->
        - [x] Migrate legacy attribute access: `damage`, `range`, `firing_arc` â†’ ability getters <!-- id: 94 -->
    - [x] **Battle UI** (7 isinstance checks per review_battle_ui.md) <!-- id: 77 -->
        - [x] Refactor `battle_ui.py`: `draw_debug_overlay` uses `WeaponAbility` (2 checks) <!-- id: 78 -->
        - [x] Refactor `battle_panels.py`: Remove `isinstance` checks in `ShipStatsPanel` (2 checks) <!-- id: 79 -->
    - [x] **Test Coverage** (from review_test_coverage.md) <!-- id: 95 -->
        - [x] Add tests for `BeamWeaponAbility`, `SeekerWeaponAbility`, `ResourceGeneration` <!-- id: 96 -->
        - [x] Add tests for `get_abilities()`, `has_pdc_ability()` helper methods <!-- id: 97 -->
        - [x] Update `MockPDC` in `test_pdc.py` to use tag-based PDC detection <!-- id: 98 -->
    - [x] **Performance** <!-- id: 58 -->
        - [x] Add `Ship.cached_summary` property <!-- id: 59 -->
        - [x] Update `ShipStatsCalculator` to populate summary <!-- id: 60 -->

- [x] **Phase 6: Data Migration** <!-- id: 61 -->
    - [x] **Pre-Migration Fixes** (from code review audits) <!-- id: 100 -->
        - [x] Add `CommandAndControl` class to `abilities.py` and `ABILITY_REGISTRY` <!-- id: 101 -->
        - [x] Verify validation passes after adding ability <!-- id: 102 -->
    - [x] **Scripting** <!-- id: 62 -->
        - [x] Create `scripts/migrate_legacy_components.py` to identify and move legacy keys <!-- id: 63 -->
        - [x] Implement dry-run mode to preview changes <!-- id: 64 -->
        - [x] Migrate weapon stats (`damage`, `range`, `reload`) into ability dict <!-- id: 103 -->
        - [x] Remove redundant `thrust_force`/`turn_speed` from engines/thrusters <!-- id: 104 -->
    - [x] **Code Fixes for Migrated Data** <!-- id: 105 -->
        - [x] Fix `WeaponAbility.__init__` to handle formula strings <!-- id: 106 -->
        - [x] Store `_base_damage/_base_range/_base_reload` for modifier sync <!-- id: 107 -->
        - [x] Update `_apply_base_stats` to use base values not data dict <!-- id: 108 -->
        - [x] Update weapon constructors (`Weapon`, `ProjectileWeapon`, `BeamWeapon`) <!-- id: 109 -->
        - [x] Update `ModifierLogic` to read `firing_arc` from ability dicts <!-- id: 110 -->
    - [x] **Validation** <!-- id: 65 -->
        - [x] Update `ship_validator.py` with `EnableAbilityConstraints` rule <!-- id: 66 -->
    - [x] **Execution** <!-- id: 67 -->
        - [x] Run migration script on `data/components.json` <!-- id: 68 -->
        - [x] Manual check of `data/components.json` <!-- id: 69 -->
        - [x] Run full test suite (**470 passed**) <!-- id: 70 -->
        - [x] Fix `test_pdc_missile_logic` (updated `_apply_base_stats` to read from ability dicts) <!-- id: 111 -->

- [ ] **Phase 7: Legacy Removal (Final Cleanup)** <!-- id: 112 -->
    - [ ] **Stage 1: Critical Fixes** <!-- id: 113 -->
        - [ ] Fix shield calculation overwrite in `ship_stats.py` <!-- id: 114 -->
        - [ ] Fix legacy armor classification checks in `ship_stats.py` <!-- id: 115 -->
    - [ ] **Stage 2: Core Logic Migration** <!-- id: 116 -->
        - [ ] Refactor `ship_combat.py`: Replace `comp.damage/range` with ability getters <!-- id: 117 -->
        - [ ] Refactor `ship_combat.py`: Replace `comp.fire()` with `ability.fire()` <!-- id: 118 -->
        - [ ] Refactor `ai.py`: Update TargetEvaluator and PDC checks to use abilities <!-- id: 119 -->
        - [ ] Refactor `ship.py`: Remove `isinstance` checks for Sensor/Electronics <!-- id: 120 -->
    - [ ] **Stage 3: UI & Rendering** <!-- id: 121 -->
        - [ ] Refactor Builder UI `weapons_panel.py` and `schematic_view.py` <!-- id: 122 -->
        - [ ] Refactor `rendering.py` color selection <!-- id: 123 -->
    - [ ] **Stage 4: Test Suite Updates** <!-- id: 124 -->
        - [ ] Update `test_components.py` to remove `isinstance(Weapon)` checks <!-- id: 125 -->
    - [ ] **Stage 5: The Big Delete** <!-- id: 126 -->
        - [ ] Remove `Weapon`, `Engine`, `Shield` subclasses from `components.py` <!-- id: 127 -->
        - [ ] Remove `_instantiate_abilities` shim logic <!-- id: 128 -->
        - [ ] Remove `__getattr__` shims (`damage`, `range`, `thrust_force`) <!-- id: 129 -->
        - [ ] Clean up unused imports across codebase <!-- id: 130 -->

