# Task List: Ability System Migration

- [x] **Phase 1: Foundation (Abilities Module)** <!-- id: 0 -->
    - [x] **Infrastructure** <!-- id: 1 -->
        - [x] Create `abilities.py` module to host `Ability` classes <!-- id: 2 -->
        - [x] Implement `Ability` base class with `update`, `on_activation`, `get_ui_rows` methods <!-- id: 3 -->
    - [x] **Resource Abilities** <!-- id: 4 -->
        - [x] Migrate `ResourceConsumption` from `resources.py` to `abilities.py` <!-- id: 5 -->
        - [x] Migrate `ResourceStorage` from `resources.py` to `abilities.py` <!-- id: 6 -->
        - [x] Migrate `ResourceGeneration` from `resources.py` to `abilities.py` <!-- id: 7 -->
    - [x] **Core Mechanic Abilities** <!-- id: 8 -->
        - [x] Implement `CombatPropulsion` (replaces `thrust_force`) <!-- id: 9 -->
        - [x] Implement `ManeuveringThruster` (replaces `turn_speed`) <!-- id: 10 -->
        - [x] Implement `ShieldProjection` (replaces `Shield.capacity`) <!-- id: 11 -->
        - [x] Implement `VehicleLaunchAbility` (replaces `Hangar` logic) <!-- id: 71 -->
        - [x] Implement `ShieldRegeneration` (replaces `ShieldRegenerator.rate`) <!-- id: 12 -->
        - [x] Implement `CommandAndControl`, `CrewCapacity`, `LifeSupportCapacity` (Implicitly supported via primitive factory or generic classes if needed, currently not strictly required as separate classes but data-driven) <!-- id: 13 -->
    - [x] **Weapon Abilities** <!-- id: 14 -->
        - [x] Implement `WeaponAbility` base class (cooldowns, reload, range) <!-- id: 15 -->
        - [x] Implement `ProjectileWeaponAbility` (spawns projectiles) <!-- id: 16 -->
        - [x] Implement `BeamWeaponAbility` (hitscan logic) <!-- id: 17 -->
        - [x] Implement `SeekerWeaponAbility` (spawns seekers) <!-- id: 18 -->
    - [x] **Registry & Factory** <!-- id: 19 -->
        - [x] Define `ABILITY_REGISTRY` in `abilities.py` <!-- id: 20 -->
        - [x] Implement `create_ability(name, component, data)` factory function <!-- id: 21 -->
    - [x] **Testing** <!-- id: 22 -->
        - [x] Create `unit_tests/test_abilities.py` to verify all new classes <!-- id: 23 -->

- [x] **Phase 2: Core Refactor (Components)** <!-- id: 24 -->
    - [x] **Component Class** <!-- id: 25 -->
        - [x] Refactor `Component.__init__` in `components.py` to strictly load abilities using the Factory <!-- id: 26 -->
        - [x] Implement `get_ability(type)` helper method <!-- id: 27 -->
        - [x] Refactor `update()` to iterate `self.ability_instances` and call `ab.update()` <!-- id: 28 -->
    - [x] **Legacy Shim (Critical)** <!-- id: 29 -->
        - [x] Add logic to `__init__`: If `thrust_force` in data, create `CombatPropulsion` ability <!-- id: 30 -->
        - [x] Add logic to `__init__`: If `turn_speed` in data, create `ManeuveringThruster` ability <!-- id: 31 -->
        - [x] Add logic to `__init__`: If `damage` in data, create appropriate `WeaponAbility` <!-- id: 32 -->
    - [x] **Testing** <!-- id: 33 -->
        - [x] Create `unit_tests/test_component_composition.py` to verify generic component behaves like an engine/weapon <!-- id: 34 -->

- [ ] **Phase 3: Stats & Physics Integration** <!-- id: 35 -->
    - [ ] **Ship Stats** <!-- id: 36 -->
        - [ ] Refactor `ship_stats.py`: Replace `if isinstance(c, Engine)` with `c.get_abilities('CombatPropulsion')` <!-- id: 37 -->
        - [ ] Refactor `ship_stats.py`: Replace `if isinstance(c, Thruster)` with `c.get_abilities('ManeuveringThruster')` <!-- id: 38 -->
        - [ ] Refactor `ship_stats.py`: Aggregate `ShieldProjection` for max shields <!-- id: 39 -->
    - [ ] **Ship Physics** <!-- id: 40 -->
        - [ ] Implement `Ship.get_total_ability_value(name, operational_only=True)` helper <!-- id: 74 -->
        - [ ] Refactor `ship_physics.py`: Replace `isinstance(Engine)` loop with `get_total_ability_value('CombatPropulsion')` <!-- id: 41 -->
        - [ ] Refactor `ship_stats.py`: Replace `isinstance(Engine)` loop with `get_total_ability_value` (unified logic) <!-- id: 75 -->
    - [ ] **Verification** <!-- id: 42 -->
        - [ ] Run `unit_tests/test_ship_stats.py` to ensure no regression in calculated stats <!-- id: 43 -->

- [ ] **Phase 4: Combat System Migration** <!-- id: 44 -->
    - [ ] **Weapon Logic** <!-- id: 45 -->
        - [ ] Refactor `Ship.max_weapon_range` in `ship.py` to use ability values <!-- id: 80 -->
        - [ ] Refactor `ship_combat.py`: `fire_weapons` iterates components with `WeaponAbility` <!-- id: 46 -->
        - [ ] Update `WeaponAbility` to manage its own `cooldown_timer` <!-- id: 47 -->
        - [ ] Bind `fire()` logic: `BeamWeaponAbility` calls `apply_damage`, `Projectile` spawns entity <!-- id: 48 -->
        - [ ] Refactor `fire_weapons`: Add `VehicleLaunchAbility` support for launching fighters <!-- id: 72 -->
        - [ ] Refactor `_find_pdc_target`: Use `Ability.tags` instead of legacy flags <!-- id: 73 -->
    - [ ] **Verification** <!-- id: 49 -->
        - [ ] Run `unit_tests/test_weapons.py` to verify firing mechanics <!-- id: 50 -->

- [ ] **Phase 5: UI & Capabilities** <!-- id: 51 -->
    - [ ] **Renderer** <!-- id: 52 -->
        - [ ] Implement `get_ui_rows()` for `CombatPropulsion` (Returns 'Thrust') <!-- id: 53 -->
        - [ ] Implement `get_ui_rows()` for `WeaponAbility` (Returns 'Damage', 'Range') <!-- id: 54 -->
        - [ ] Update `Component.get_ui_rows()` to aggregate from abilities <!-- id: 55 -->
    - [ ] **Builder UI** <!-- id: 56 -->
        - [ ] Refactor `ui/builder/detail_panel.py` `show_component` to use `get_ui_rows()` <!-- id: 57 -->
        - [ ] Refactor `ui/builder/weapons_panel.py`: Remove `isinstance` checks, use `has_ability()` <!-- id: 76 -->
    - [ ] **Battle UI** <!-- id: 77 -->
        - [ ] Refactor `battle_ui.py`: `draw_debug_overlay` uses `WeaponAbility` <!-- id: 78 -->
        - [ ] Refactor `battle_panels.py`: Remove `isinstance` checks in `ShipStatsPanel` <!-- id: 79 -->
    - [ ] **Performance** <!-- id: 58 -->
        - [ ] Add `Ship.cached_summary` property <!-- id: 59 -->
        - [ ] Update `ShipStatsCalculator` to populate summary <!-- id: 60 -->

- [ ] **Phase 6: Data Migration** <!-- id: 61 -->
    - [ ] **Scripting** <!-- id: 62 -->
        - [ ] Create `scripts/migrate_legacy_components.py` to identify and move legacy keys <!-- id: 63 -->
        - [ ] Implement dry-run mode to preview changes <!-- id: 64 -->
    - [ ] **Validation** <!-- id: 65 -->
        - [ ] Update `ship_validator.py` with `EnableAbilityConstraints` rule <!-- id: 66 -->
    - [ ] **Execution** <!-- id: 67 -->
        - [ ] Run migration script on `data/components.json` <!-- id: 68 -->
        - [ ] Manual check of `data/components.json` <!-- id: 69 -->
        - [ ] Run full test suite <!-- id: 70 -->
