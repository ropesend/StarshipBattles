# Task List: Ability System Migration

- [x] **Phase 1: Foundation (Abilities Module)** <!-- id: 0 -->
    - [x] **Infrastructure** <!-- id: 1 -->
        - [x] Create `abilities.py` module to host `Ability` classes <!-- id: 2 -->
        - [x] Implement `Ability` base class with `update`, `on_activation`, `get_ui_rows` methods <!-- id: 3 -->
    - [x] **Resource Abilities** <!-- id: 4 -->
        - [x] Migrate `ResourceConsumption` from `resources.py` to `abilities.py` <!-- id: 5 -->
        - [x] Migrate `ResourceStorage` from `resources.py` to `abilities.py` <!-- id: 6 -->
        - [x] Migrate `ResourceGeneration` from `resources.py` to `abilities.py` <!-- id: 7 -->
    - [x] **Core Mechanic Abilities** <!-- id: 8 -->
        - [x] Implement `CombatPropulsion` (replaces `thrust_force`) <!-- id: 9 -->
        - [x] Implement `ManeuveringThruster` (replaces `turn_speed`) <!-- id: 10 -->
        - [x] Implement `ShieldProjection` (replaces `Shield.capacity`) <!-- id: 11 -->
        - [x] Implement `VehicleLaunchAbility` (replaces `Hangar` logic) <!-- id: 71 -->
        - [x] Implement `ShieldRegeneration` (replaces `ShieldRegenerator.rate`) <!-- id: 12 -->
        - [x] Implement `CommandAndControl`, `CrewCapacity`, `LifeSupportCapacity` <!-- id: 13 -->
    - [x] **Weapon Abilities** <!-- id: 14 -->
        - [x] Implement `WeaponAbility` base class (cooldowns, reload, range) <!-- id: 15 -->
        - [x] Implement `ProjectileWeaponAbility` (spawns projectiles) <!-- id: 16 -->
        - [x] Implement `BeamWeaponAbility` (hitscan logic) <!-- id: 17 -->
        - [x] Implement `SeekerWeaponAbility` (spawns seekers) <!-- id: 18 -->
    - [x] **Registry & Factory** <!-- id: 19 -->
        - [x] Define `ABILITY_REGISTRY` in `abilities.py` <!-- id: 20 -->
        - [x] Implement `create_ability(name, component, data)` factory function <!-- id: 21 -->
    - [x] **Testing** <!-- id: 22 -->
        - [x] Create `unit_tests/test_abilities.py` to verify all new classes <!-- id: 23 -->

- [x] **Phase 2: Core Refactor (Components)** <!-- id: 24 -->
    - [x] **Component Class** <!-- id: 25 -->
        - [x] Refactor `Component.__init__` in `components.py` to strictly load abilities using the Factory <!-- id: 26 -->
        - [x] Implement `get_ability(type)` helper method <!-- id: 27 -->
        - [x] Refactor `update()` to iterate `self.ability_instances` and call `ab.update()` <!-- id: 28 -->
    - [x] **Legacy Shim (Critical)** <!-- id: 29 -->
        - [x] Add logic to `__init__`: If `thrust_force` in data, create `CombatPropulsion` ability <!-- id: 30 -->
        - [x] Add logic to `__init__`: If `turn_speed` in data, create `ManeuveringThruster` ability <!-- id: 31 -->
        - [x] Add logic to `__init__`: If `damage` in data, create appropriate `WeaponAbility` <!-- id: 32 -->
    - [x] **Testing** <!-- id: 33 -->
        - [x] Create `unit_tests/test_component_composition.py` <!-- id: 34 -->

- [x] **Phase 3: Stats & Physics Integration** <!-- id: 35 -->
    - [x] **Ship Stats** <!-- id: 36 -->
        - [x] Create `unit_tests/test_ship_stats.py` baseline <!-- id: 81 -->
        - [x] Refactor `ship_stats.py`: Replace `isinstance(Engine)` with `get_abilities('CombatPropulsion')` <!-- id: 37 -->
        - [x] Refactor `ship_stats.py`: Replace `isinstance(Thruster)` with `get_abilities('ManeuveringThruster')` <!-- id: 38 -->
        - [x] Refactor `ship_stats.py`: Aggregate `ShieldProjection` for max shields <!-- id: 39 -->
    - [x] **Ship Physics** <!-- id: 40 -->
        - [x] Implement `Ship.get_total_ability_value(name, operational_only=True)` helper <!-- id: 74 -->
        - [x] Refactor `ship_physics.py`: Replace `isinstance(Engine)` loop with `get_total_ability_value` <!-- id: 41 -->
    - [x] **Verification** <!-- id: 42 -->
        - [x] Run `unit_tests/test_ship_stats.py` to ensure no regression <!-- id: 43 -->

- [x] **Phase 4: Combat System Migration** <!-- id: 44 -->
    - [x] **Weapon Logic** <!-- id: 45 -->
        - [x] Refactor `Ship.max_weapon_range` to use ability values <!-- id: 80 -->
        - [x] Refactor `ship_combat.py`: `fire_weapons` iterates components with `WeaponAbility` <!-- id: 46 -->
        - [x] Update `WeaponAbility` to manage its own `cooldown_timer` <!-- id: 47 -->
        - [x] Bind `fire()` logic to return attack data to battle engine <!-- id: 48 -->
        - [x] Refactor `fire_weapons`: Add `VehicleLaunchAbility` support <!-- id: 72 -->
        - [x] Refactor `_find_pdc_target`: Use `Ability.tags` instead of legacy flags <!-- id: 73 -->
    - [x] **Verification** <!-- id: 49 -->
        - [x] Run `unit_tests/test_weapons.py` to verify firing mechanics <!-- id: 50 -->

- [x] **Phase 5: UI & Capabilities** <!-- id: 51 -->
    - [x] **Renderer** <!-- id: 52 -->
        - [x] Implement `get_ui_rows()` for `CombatPropulsion` <!-- id: 53 -->
        - [x] Implement `get_ui_rows()` for `WeaponAbility` <!-- id: 54 -->
        - [x] Update `Component.get_ui_rows()` to aggregate from abilities <!-- id: 55 -->
    - [x] **Builder UI** <!-- id: 56 -->
        - [x] Refactor `ui/builder/detail_panel.py` to use `get_ui_rows()` <!-- id: 57 -->
        - [x] Refactor `ui/builder/weapons_panel.py` <!-- id: 76 -->
    - [x] **Test Coverage** <!-- id: 95 -->
        - [x] Add tests for `BeamWeaponAbility`, `SeekerWeaponAbility` <!-- id: 96 -->
        - [x] Add tests for `get_abilities()`, `has_pdc_ability()` <!-- id: 97 -->
    - [x] **Performance** <!-- id: 58 -->
        - [x] Add `Ship.cached_summary` property <!-- id: 59 -->

- [x] **Phase 6: Data Migration** <!-- id: 61 -->
    - [x] **Pre-Migration Fixes** <!-- id: 100 -->
        - [x] Add `CommandAndControl` class to `abilities.py` <!-- id: 101 -->
    - [x] **Scripting** <!-- id: 62 -->
        - [x] Create `scripts/migrate_legacy_components.py` <!-- id: 63 -->
        - [x] Migrate weapon stats into ability dict <!-- id: 103 -->
        - [x] Remove redundant `thrust_force`/`turn_speed` from engines <!-- id: 104 -->
    - [x] **Execution** <!-- id: 67 -->
        - [x] Run migration script on `data/components.json` <!-- id: 68 -->
        - [x] Run full test suite (**470 passed**) <!-- id: 70 -->

- [x] **Phase 7: Legacy Removal** <!-- id: 112 -->
    - [x] **Stage 1: Critical Fixes** <!-- id: 113 -->
        - [x] Delete `ship_stats.py:325-330` (shield overwrite bug) <!-- id: 114 -->
        - [x] Delete `builder.py` (dead code) <!-- id: 131 -->
        - [x] Fix armor classification checks in `ship_stats.py:72,78,182` <!-- id: 115 -->
    - [x] **Stage 2: Core Logic** <!-- id: 116 -->
        - [x] `ship_combat.py`: Replace 15+ `comp.damage/range` accesses <!-- id: 117 -->
        - [x] `ship_combat.py`: Replace `comp.fire()` with `ability.fire()` <!-- id: 118 -->
        - [x] `collision_system.py:67,71`: Replace `beam_comp` method calls <!-- id: 132 -->
        - [x] `projectile_manager.py:100-127`: Replace `source_weapon` access <!-- id: 133 -->
        - [x] `ai.py:188`: Replace `hasattr(c, 'damage')` with ability check <!-- id: 119 -->
        - [x] `ai.py:372,383`: Replace `comp.range/firing_arc` with ability access <!-- id: 134 -->
        - [x] `ship.py:598,607,610`: Replace `isinstance(Sensor/Electronics)` <!-- id: 120 -->
    - [x] **Stage 3: UI & Rendering** <!-- id: 121 -->
        - [x] `detail_panel.py:5-7,115,132,142,153-198`: Remove legacy imports/patterns <!-- id: 135 -->
        - [x] `weapons_panel.py`: Replace 10+ `getattr(weapon, ...)` calls <!-- id: 122 -->
        - [x] `modifier_logic.py:123,161`: Read from ability dict <!-- id: 136 -->
        - [x] `schematic_view.py:125-127`: Replace legacy attribute access <!-- id: 137 -->
        - [x] `battle_ui.py:135-162`: Replace debug overlay attributes <!-- id: 138 -->
        - [x] `rendering.py:123`: Replace `type_str == 'Armor'` check <!-- id: 123 -->
    - [x] **Stage 4: Data Files** <!-- id: 139 -->
        - [x] `modifiers.json`: Migrate `allow_types` → `allow_abilities` (10+ entries) <!-- id: 140 -->
        - [x] `components.json:481`: Replace `PointDefense: true` with ability/tag <!-- id: 141 -->
        - [x] `ship_validator.py:113,136`: Support ability-based restrictions <!-- id: 142 -->
    - [x] **Stage 5: Test Suite** <!-- id: 124 -->
        - [x] `test_components.py:32,36`: Replace `isinstance` assertions <!-- id: 125 -->
        - [x] `test_ship_stats.py`: Replace legacy instantiation (6+ locations) <!-- id: 143 -->
        - [x] `test_combat.py:110,151,247`: Replace `isinstance(Bridge/Weapon)` <!-- id: 144 -->
        - [x] `test_pdc.py:13,65-66`: Fix `MockPDC` inheritance <!-- id: 145 -->
        - [x] `test_modifiers.py:113,122-123`: Replace `isinstance(Weapon)` <!-- id: 146 -->
        - [x] `test_strategy_system.py:77`: Replace `c1.damage = 10` mock <!-- id: 147 -->
        - [x] `test_builder_validation.py:53,57,69-84`: Use tags not classification <!-- id: 148 -->
    - [x] **Stage 6: The Big Delete** <!-- id: 126 -->
        - [x] `Bridge` class → `Bridge = Component` alias <!-- id: 127 -->
        - [x] `Engine`, `Thruster` → `Component` aliases <!-- id: 149a -->
        - [x] `Tank`, `Armor`, `Generator` → `Component` aliases <!-- id: 149b -->
        - [x] `Weapon`, `ProjectileWeapon` → `Component` aliases <!-- id: 127c -->
        - [x] `BeamWeapon`, `SeekerWeapon` → `Component` aliases <!-- id: 127d -->
        - [x] **AUDIT**: No `isinstance` checks remain for any legacy class <!-- id: 127b -->
        - [x] Fixed seeker range tests (0.8 maneuvering factor in ability) <!-- id: 127e -->
        - [x] Delete `_instantiate_abilities` shim logic <!-- id: 128 -->
        - [x] Simplify `COMPONENT_TYPE_MAP` - many entries now point to `Component` <!-- id: 150 -->
        - [x] Clean up unused imports across codebase <!-- id: 130 -->
    - [ ] **Future: Modifier → Ability Value Sync** <!-- id: 151 -->
        - When modifiers change stats (e.g., `endurance_mult`), ability values should recalculate
        - Currently abilities read from data dict; modifiers affect stats dict
        - Removed legacy `SeekerWeapon._apply_custom_stats` that bridged this gap

