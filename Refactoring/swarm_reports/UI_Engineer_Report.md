# UI Engineer Report - Hull Layer Integration

**Focus:** UI modifications for Hull Layer readability and read-only blocking.
**Generated By:** UI_Engineer Status: **COMPLETE**

## 1. Analysis of `ui/builder/layer_panel.py`

### Visibility
The current implementation explicitly lists layers in `rebuild()`:
```python
layer_order = [LayerType.CORE, LayerType.INNER, LayerType.OUTER, LayerType.ARMOR]
```
**Change Required:**
- Need to import `LayerType` (already imported).
- Update `layer_order` to include `LayerType.HULL`. Placement currently recommended as **first** (Innermost) or **last** (depends on visual stack).
- **Recommendation:** Place `LayerType.HULL` at the **TOP** of the list (Index 0) to represent the chassis/base, or **BOTTOM** if "Innermost" implies buried. Given the plan says "Innermost layer", and standard UI often shows "Core" at top, but "Hull" is the container. Let's place it at the **TOP** so it's the first thing seen: The Ship itself.

### Interaction Blocking (Read-Only Mode)
The `LayerComponentItem` and `IndividualComponentItem` classes expose their buttons publicly. We can disable them immediately after instantiation or update.

**Proposed Logic for `rebuild()`:**

```python
# ... inside main loop ...
is_hull_layer = (l_type == LayerType.HULL)

# ... when checking/creating LayerComponentItem ...
item = self.ui_cache.get(item_key)
if not item:
    item = LayerComponentItem(...)
    self.ui_cache[item_key] = item

# APPLY READ-ONLY STATE
if is_hull_layer:
    if hasattr(item, 'add_button'):
        item.add_button.hide()
        item.add_button.disable()
    if hasattr(item, 'remove_button'):
        item.remove_button.hide()
        item.remove_button.disable()

# ... when checking/creating IndividualComponentItem ...
ind_item = self.ui_cache.get(ind_key)
if not ind_item:
    ind_item = IndividualComponentItem(...)
    self.ui_cache[ind_key] = ind_item

if is_hull_layer:
    if hasattr(ind_item, 'add_button'):
        ind_item.add_button.hide()
        ind_item.add_button.disable()
    if hasattr(ind_item, 'remove_button'):
        ind_item.remove_button.hide()
        ind_item.remove_button.disable()
    if hasattr(ind_item, 'drag_button'):
        ind_item.drag_button.hide()
        ind_item.drag_button.disable()
```

### Action Handling
Update `handle_item_action` to prevent drag/drop initiation for Hull items, just in case.

```python
def handle_item_action(self, action, payload):
    # Security Check: Prevent modifying HULL layer
    # We need to determine if payload belongs to Hull.
    # Payload is either a component or a group_key.
    
    is_hull_action = False
    
    # Check Component
    if hasattr(payload, 'layer_type_value'): # Assuming component has layer info or we check ship
         # Helper currently missing on component, checked via loop below
         pass
         
    # Check ship layers for payload validation
    if action in [ACTION_START_DRAG, ACTION_REMOVE_INDIVIDUAL, ACTION_REMOVE_GROUP]:
        # Iterate to find layer of payload
        for l_type, l_data in self.builder.ship.layers.items():
            if l_type == LayerType.HULL:
                # Check if payload is component in this layer
                if isinstance(payload, Component): # pseudocode type check
                    if payload in l_data['components']:
                        return False # Block action
                # Check group key
                # ... (Logic to match group key to hull components) ...
```

**Refined Approach:** Since we hide buttons, `handle_item_action` triggers are unlikely. However, `ACTION_START_DRAG` is critical. We will add a check:
```python
elif action == ACTION_START_DRAG:
    # Check if comp is in HULL
    if self.builder.ship.is_component_in_layer(payload, LayerType.HULL):
        return False
```
*(Note: `is_component_in_layer` might not exist, need manual check)*

## 2. Modifications to `game/ui/screens/builder_screen.py`

### Selection & Modifier Panel
We must prevent editing of Hull components via the `ModifierEditorPanel`.

**Change Required in `rebuild_modifier_ui()`:**
```python
def rebuild_modifier_ui(self):
    editing_component = self.selected_component[2] if self.selected_component else None
    
    # BLOCK HULL EDITING
    if editing_component:
        # Check layer
        is_hull = False
        if LayerType.HULL in self.ship.layers:
            if editing_component in self.ship.layers[LayerType.HULL]['components']:
                is_hull = True
                
        if is_hull:
            # Option A: Hide Panel
            self.modifier_container_panel.hide()
            return
            
    # Standard Behavior
    self.modifier_container_panel.show()
    self.modifier_panel.rebuild(editing_component, self.template_modifiers)
    self.modifier_panel.layout(0)
```

**Alternative Recommendation:**
Instead of hiding the whole container (which might leave a hole), we should clear the modifier panel or show a "Read Only" label. Since `ModifierEditorPanel` is not in context, Hiding/Showing the container is the safest "black box" approach.

### Selection Logic
Allow selection (so users can see stats in Detail Panel), but block modification.
No changes strictly needed in `on_selection_changed` if `rebuild_modifier_ui` handles the blocking.

## 3. Summary of Files to Modify

1.  **`ui/builder/layer_panel.py`**
    -   Import `LayerType`.
    -   Update `rebuild()`: Add `LayerType.HULL` to `layer_order`. Use "Top" position (Index 0).
    -   Update `rebuild()`: Add "Read Only" styling (hide/disable buttons) for `LayerComponentItem` and `IndividualComponentItem` when `l_type == LayerType.HULL`.
    -   Update `handle_item_action()`: Add guard block for `ACTION_START_DRAG` if component is in Hull layer.

2.  **`game/ui/screens/builder_screen.py`**
    -   Update `rebuild_modifier_ui()`: Check if `editing_component` is in Hull layer. If yes, hide `modifier_container_panel` or prevent `modifier_panel.rebuild`.

## 4. Risks & Dependencies
-   **Dependency:** `LayerType.HULL` must be defined in `game.simulation.entities.ship` (Simulation Architect task).
-   **Dependency:** `ship.layers` must be initialized with `LayerType.HULL` (Simulation Architect task).
-   **Risk:** If `ModifierEditorPanel` is hidden, the layout might look empty.
    -   *Mitigation:* `UIPanel` background will remain if we only hide contents, or we hide the `modifier_container_panel` itself. The `BuilderScreen` layout assumes fixed heights. Logic in `update` might need to ensure `modifier_panel` updates don't crash if hidden.
