# Active Refactor: Hull Layer Migration
**Status:** [Complete]
**Completion Date:** 2026-01-08

## Goal
Move the Hull component from `LayerType.CORE` to a dedicated `LayerType.HULL` (Index 0) to separate the chassis from internal components. This ensures architectural clarity ("Innermost" layer) and allows proper UI blocking/read-only behavior without hacky name-based filtering.

## Migration Map (The Constitution)
| Item | Source | Destination | Status |
| :--- | :--- | :--- | :--- |
| **Logic** | `LayerType.CORE` | `LayerType.HULL` (0) | [Complete] |
| **Data** | `ship.layers[CORE]` | `ship.layers[HULL]` | [Complete] |
| **UI** | Mixed Filter | Explicit `HULL` Layer (Read-Only) | [Complete] |

## Test Triage Table
| Test File | Status | Notes |
| :--- | :--- | :--- |
| `tests/unit/entities/test_ship_core.py` | **PASS (Fixed)** | Updated to expect HULL layer. |
| `tests/unit/entities/test_hull_layer.py` | **PASS (New)** | Verified Layer 0 ordinality, serialization, and auto-equip. |
| `tests/unit/systems/test_layer_refinements.py` | **PASS (Fixed)** | Updated count logic for mandatory HULL layer. |
| `tests/repro_issues/test_bug_11_hull_update.py` | **PASS (Updated)** | Verified hull auto-updates on class change in new layer. |

## Phased Schedule

### Phase 1: Core Simulation Implementation
**Goal:** Establish the backend data model changes.

- [x] **1.1: Component Enum Update**
  - **File:** `game/simulation/components/component.py`
  - **Action:** Add `HULL = 0` to `LayerType`.
  
- [x] **1.2: Ship Layer Initialization**
  - **File:** `game/simulation/entities/ship.py`
  - **Action:** Update `_initialize_layers` to forcefully create `LayerType.HULL`.
  - **Action:** Update `__init__` and `change_class` to auto-equip Hull to `LayerType.HULL` instead of `CORE`.
  - **Action:** Update `to_dict` to block serialization of `LayerType.HULL` key (autogenerated on load).

### Phase 2: UI Read-Only Integration
**Goal:** Expose the new layer in UI but prevent user modification.

- [x] **2.1: Layer Panel Visibility & Blocking**
  - **File:** `ui/builder/layer_panel.py`
  - **Action:** Add `LayerType.HULL` to `rebuild()`'s `layer_order` (must be at index 0).
  - **Action:** In `rebuild()`, calculate `is_readonly = (l_type == LayerType.HULL)`.
  - **Action:** Pass `is_readonly` to `LayerHeaderItem` and `LayerComponentItem` constructors.
  - **Logic:** `LayerHeaderItem` should hide "Add" buttons if `readonly`. `LayerComponentItem` should hide "Remove" buttons if `readonly`.
  - **Action:** In `handle_item_action()`, if action is `ACTION_START_DRAG`, check the payload. If `comp.layer_assigned == LayerType.HULL`, return `False` to prevent pickup.

- [x] **2.2: Builder Screen Protection**
  - **File:** `game/ui/screens/builder_screen.py`
  - **Action:** In `on_selection_changed()`, check if any selected component is in `LayerType.HULL`.
  - **Action:** If a HULL component is selected, notify `modifier_panel` to set read-only mode (hide/disable controls).
  - **Logic:** Provide a "Read Only: Chassis Component" overlay or label in the modifier panel.

### Phase 3: Verification & Test Remediation
**Goal:** Prove stability and regression safety.

- [x] **3.1: New Hull Suite**
  - **File:** `tests/unit/entities/test_hull_layer.py`
  - **Action:** Create test suite verifying:
    - `ship.layers` contains `HULL`.
    - Hull component is in `HULL`, not `CORE`.
    - `ship.mass` includes Hull mass.
    - `ship.to_dict()` excludes Hull.

- [x] **3.2: Update Reproduction Tests**
  - **File:** `tests/repro_issues/test_bug_11_hull_update.py`
  - **Action:** Update `CORE` checks to `HULL` layer checks.

- [x] **3.3: Full Regression Gauntlet**
  - **Action:** Run all tests in `tests/unit/entities/`.
  - **Definition of Done:** All tests pass.

### Final Phase: Definition of Done
1.  `pytest tests/unit/entities/` passes 100%.
2.  Ship Builder loads ships correctly.
3.  Hull is visible in Structure List but cannot be dragged or deleted.
4.  Saving/Loading a ship preserves stats but does not duplicate the Hull component.
5.  Reproduction tests for BUG-11 pass in the new architecture.
